# Copyright (c) HashiCorp, Inc.
# SPDX-License-Identifier: MPL-2.0

suite: Do not creare a ServiceAccount
templates:
  - serviceaccount.yaml
release:
  name: this
  namespace: default
tests:
  - it: Should Not Create a Service Account
    set:
      serviceAccount.create: false
    asserts:
      - hasDocuments:
          count: 0
---
suite: Create a ServiceAccount
templates:
  - serviceaccount.yaml
release:
  name: this
  namespace: default
tests:
  - it: Should Create a Service Account
    set:
      serviceAccount.create: true
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: ServiceAccount
      - equal:
          path: metadata.name
          value: this-hcp-terraform-operator
      - equal:
          path: metadata.namespace
          value: default
      - notExists:
          path: metadata.annotations
      - exists:
          path: metadata.labels
      - isNotNullOrEmpty:
          path: metadata.labels
      - equal:
          path: metadata.labels
          value:
            app.kubernetes.io/instance: this
            app.kubernetes.io/managed-by: Helm
            app.kubernetes.io/name: hcp-terraform-operator
            app.kubernetes.io/version: 2.7.0
            helm.sh/chart: hcp-terraform-operator-2.7.0
---
suite: Create a ServiceAccount in a custom Namespace
templates:
  - serviceaccount.yaml
release:
  name: this
  namespace: this
tests:
  - it: Should Create a Service Account in a Custom Namespace
    set:
      serviceAccount.create: true
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: ServiceAccount
      - equal:
          path: metadata.name
          value: this-hcp-terraform-operator
      - equal:
          path: metadata.namespace
          value: this
      - notExists:
          path: metadata.annotations
      - exists:
          path: metadata.labels
      - isNotNullOrEmpty:
          path: metadata.labels
      - equal:
          path: metadata.labels
          value:
            app.kubernetes.io/instance: this
            app.kubernetes.io/managed-by: Helm
            app.kubernetes.io/name: hcp-terraform-operator
            app.kubernetes.io/version: 2.7.0
            helm.sh/chart: hcp-terraform-operator-2.7.0
---
suite: Create a ServiceAccount with a custom name
templates:
  - serviceaccount.yaml
release:
  name: this
  namespace: default
tests:
  - it: Should Create a Service Account with a Custom Name
    set:
      serviceAccount.create: true
      serviceAccount.name: this
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: ServiceAccount
      - equal:
          path: metadata.name
          value: this
      - equal:
          path: metadata.namespace
          value: default
      - notExists:
          path: metadata.annotations
      - exists:
          path: metadata.labels
      - isNotNullOrEmpty:
          path: metadata.labels
      - equal:
          path: metadata.labels
          value:
            app.kubernetes.io/instance: this
            app.kubernetes.io/managed-by: Helm
            app.kubernetes.io/name: hcp-terraform-operator
            app.kubernetes.io/version: 2.7.0
            helm.sh/chart: hcp-terraform-operator-2.7.0
---
suite: Create a ServiceAccount with custom annotations
templates:
  - serviceaccount.yaml
release:
  name: this
  namespace: default
tests:
  - it: Should Create a Service Account with Custom Annotations
    set:
      serviceAccount.create: true
      serviceAccount.annotations:
        app.kubernetes.io/name: hcp-terraform-operator
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: ServiceAccount
      - equal:
          path: metadata.namespace
          value: default
      - exists:
          path: metadata.annotations
      - isSubset:
          path: metadata.annotations
          content:
            app.kubernetes.io/name: hcp-terraform-operator
      - exists:
          path: metadata.labels
      - isNotNullOrEmpty:
          path: metadata.labels
      - equal:
          path: metadata.labels
          value:
            app.kubernetes.io/instance: this
            app.kubernetes.io/managed-by: Helm
            app.kubernetes.io/name: hcp-terraform-operator
            app.kubernetes.io/version: 2.7.0
            helm.sh/chart: hcp-terraform-operator-2.7.0
