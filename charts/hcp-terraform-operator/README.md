<!--
  The README.md file is autogenerated by https://github.com/norwoodj/helm-docs.
  Make changes _only_ in the README.md.gotmpl file and then run `make helm-docs` to generate the README.md file.
-->

# Installation

Use the option `--version VERSION` with `helm install` and `helm upgrade` commands to specify the version you want to install.

## Steps

1. Add the Helm repository

    ```console
    $ helm repo add hashicorp https://helm.releases.hashicorp.com
    ```

2. Update your local Helm chart repository cache

    ```console
    $ helm repo update
    ```

3. Install

    ```console
    $ helm install demo hashicorp/hcp-terraform-operator \
      --version 2.7.0 \
      --namespace tfc-operator-system \
      --create-namespace
    ```

Below are examples of the Operator installation/upgrade Helm chart with options.

### Install with options

```console
$ helm install demo hashicorp/hcp-terraform-operator \
  --version 2.7.0 \
  --namespace tfc-operator-system \
  --create-namespace \
  --set operator.syncPeriod=10m \
  --set 'operator.watchedNamespaces={white,blue,red}' \
  --set controllers.agentPool.workers=5 \
  --set controllers.module.workers=5 \
  --set controllers.project.workers=5 \
  --set controllers.workspace.workers=5
```

In the above example, the Operator will watch 3 namespaces in the Kubernetes cluster: `white`, `blue`, and `red`.

### Install to work with Terraform Enterprise

If targeting a Terraform Enterprise instance rather than HCP Terraform, set the API endpoint URL using the `operator.tfeAddress` value:

```console
$ helm install demo hashicorp/hcp-terraform-operator \
  --version 2.7.0 \
  --set operator.tfeAddress="https://tfe-api.my-company.com"
```

If you encounter a TLS-related issue using the Operator with Terraform Enterprise, you may need to configure your own CA certificates using the [`customCAcertificates`](./README.md#values) value, or by skipping TLS verification using the [`operator.skipTLSVerify`](./README.md#values) value.

For more information, please refer to the [FAQ](./../../docs/faq.md#general-questions).

### Upgrade with options

```console
$ helm upgrade demo hashicorp/hcp-terraform-operator \
  --version 2.7.0 \
  --namespace hcp-terraform-operator-system \
  --set operator.syncPeriod=5m \
  --set controllers.agentPool.workers=5 \
  --set controllers.module.workers=10 \
  --set controllers.project.workers=2 \
  --set controllers.workspace.workers=20
```

In the above example, the Operator will watch all namespaces in the Kubernetes cluster.

In some cases, such as when a new version of the Operator adds a new controller and, consequently, a new CRD, or when it changes an existing CRD schema, manual steps will be required to update the CRD. This is necessary because [Helm does not upgrade CRDs](https://helm.sh/docs/chart_best_practices/custom_resource_definitions/#some-caveats-and-explanations) during the upgrade operation. In both cases, manual steps involving [`kubectl apply`](https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#apply) or [`kubectl replace`](https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#replace) must be performed to add a new CRD or upgrade the existing one.

For a more detailed explanation, please refer to the [FAQ](../../docs/faq.md#general-questions).

#### Upgrade recommendations

  - `2.6.0` to `2.7.0`

    - The `Workspace` CRD has been changed:

      ```console
      $ kubectl replace -f https://raw.githubusercontent.com/hashicorp/hcp-terraform-operator/v2.7.0/charts/hcp-terraform-operator/crds/app.terraform.io_workspaces.yaml
      ```

    - The `AgentPool` CRD has been changed:

      ```console
      $ kubectl replace -f https://raw.githubusercontent.com/hashicorp/hcp-terraform-operator/v2.7.0/charts/hcp-terraform-operator/crds/app.terraform.io_agentpools.yaml
      ```

  - `2.5.0` to `2.6.0`

    - The `AgentPool` CRD has been changed:

      ```console
      $ kubectl replace -f https://raw.githubusercontent.com/hashicorp/hcp-terraform-operator/v2.6.0/charts/hcp-terraform-operator/crds/app.terraform.io_agentpools.yaml
      ```

  - `2.3.0` to `2.4.0`

    - The `Workspace` CRD has been changed:

      ```console
      $ kubectl replace -f https://raw.githubusercontent.com/hashicorp/hcp-terraform-operator/v2.4.0/charts/terraform-cloud-operator/crds/app.terraform.io_workspaces.yaml
      ```

  - `2.2.0` to `2.3.0`

    - The `Workspace` CRD has been changed:

      ```console
      $ kubectl replace -f https://raw.githubusercontent.com/hashicorp/hcp-terraform-operator/v2.3.0/charts/terraform-cloud-operator/crds/app.terraform.io_workspaces.yaml
      ```

  - `2.1.0` to `2.2.0`

    - A new controller `Project` has been added:

      ```console
      $ kubectl apply -f https://raw.githubusercontent.com/hashicorp/hcp-terraform-operator/v2.2.0/charts/terraform-cloud-operator/crds/app.terraform.io_projects.yaml
      ```

  - `2.0.0` to `2.1.0`

    - The `Workspace` CRD has been changed:

      ```console
      $ kubectl replace -f https://raw.githubusercontent.com/hashicorp/hcp-terraform-operator/v2.1.0/charts/terraform-cloud-operator/crds/app.terraform.io_workspaces.yaml
      ```

  - `2.0.0-betaX` to `2.0.0`

    - The `AgentPool` CRD has been changed:

      ```console
      $ kubectl replace -f https://raw.githubusercontent.com/hashicorp/hcp-terraform-operator/v2.0.0/charts/terraform-cloud-operator/crds/app.terraform.io_agentpools.yaml
      ```

# Values

| Key | Type | Default | Description |
|-----|------|---------|-------------|
| controllers.agentPool.syncPeriod | string | `"30s"` | The minimum frequency at which watched Agent Pool resources are reconciled. Format: 5s, 1m, etc. |
| controllers.agentPool.workers | int | `1` | The number of the Agent Pool controller workers. |
| controllers.module.syncPeriod | string | `"5m"` | The minimum frequency at which watched Module resources are reconciled. Format: 5s, 1m, etc. |
| controllers.module.workers | int | `1` | The number of the Module controller workers. |
| controllers.project.syncPeriod | string | `"5m"` | The minimum frequency at which watched Project resources are reconciled. Format: 5s, 1m, etc. |
| controllers.project.workers | int | `1` | The number of the Project controller workers. |
| controllers.workspace.syncPeriod | string | `"5m"` | The minimum frequency at which watched Workspace resources are reconciled. Format: 5s, 1m, etc. |
| controllers.workspace.workers | int | `1` | The number of the Workspace controller workers. |
| customCAcertificates | string | `""` | Custom Certificate Authority bundle to validate API TLS certificates. Expects a path to a CRT file containing concatenated certificates. |
| imagePullSecrets | list | `[]` | Reference to one or more secrets essential for pulling container images. |
| kubeRbacProxy.image.pullPolicy | string | `"IfNotPresent"` | Image pull policy. |
| kubeRbacProxy.image.repository | string | `"quay.io/brancz/kube-rbac-proxy"` | Image repository. |
| kubeRbacProxy.image.tag | string | `"v0.18.2"` | Image tag. |
| kubeRbacProxy.resources.limits.cpu | string | `"500m"` | Limits as a maximum amount of CPU to be used by a container. |
| kubeRbacProxy.resources.limits.memory | string | `"128Mi"` | Limits as a maximum amount of memory to be used by a container. |
| kubeRbacProxy.resources.requests.cpu | string | `"50m"` | Guaranteed minimum amount of CPU to be used by a container. |
| kubeRbacProxy.resources.requests.memory | string | `"64Mi"` | Guaranteed minimum amount of memory to be used by a container. |
| kubeRbacProxy.securityContext | object | `{"allowPrivilegeEscalation":false,"capabilities":{"drop":["ALL"]},"seccompProfile":{"type":"RuntimeDefault"}}` | Container security context. More information in [Kubernetes documentation](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/). |
| operator.affinity | object | `{}` | Kubernetes Affinity. More information: https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/#affinity-and-anti-affinity |
| operator.image.pullPolicy | string | `"IfNotPresent"` | Image pull policy. |
| operator.image.repository | string | `"hashicorp/hcp-terraform-operator"` | Image repository. |
| operator.image.tag | string | `""` | Image tag. Defaults to `.Chart.AppVersion`. |
| operator.resources.limits.cpu | string | `"500m"` | Limits as a maximum amount of CPU to be used by a container. |
| operator.resources.limits.memory | string | `"128Mi"` | Limits as a maximum amount of memory to be used by a container. |
| operator.resources.requests.cpu | string | `"50m"` | Guaranteed minimum amount of CPU to be used by a container. |
| operator.resources.requests.memory | string | `"64Mi"` | Guaranteed minimum amount of memory to be used by a container. |
| operator.securityContext | object | `{"allowPrivilegeEscalation":false,"capabilities":{"drop":["ALL"]},"seccompProfile":{"type":"RuntimeDefault"}}` | Container security context. More information in [Kubernetes documentation](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/). |
| operator.skipTLSVerify | bool | `false` | Whether or not to ignore TLS certification warnings. |
| operator.syncPeriod | string | `"1h"` | The minimum frequency at which watched resources are reconciled. Format: `5s`, `1m`, etc. |
| operator.tfeAddress | string | `""` | The API URL of a Terraform Enterprise instance. |
| operator.tolerations | list | `[]` | Kubernetes Tolerations. More information: https://kubernetes.io/docs/concepts/scheduling-eviction/taint-and-toleration/ |
| operator.watchedNamespaces | list | `[]` | List of namespaces the controllers should watch. |
| podLabels | object | `{}` | Additional labels to add to the Operator pods. |
| priorityClassName | string | `""` | Deployment priorityClassName. More information in [Kubernetes documentation](https://kubernetes.io/docs/concepts/scheduling-eviction/pod-priority-preemption/). |
| rbac.create | bool | `true` | Specifies whether a Role-Based Access Control (RBAC) resources should be created |
| replicaCount | int | `2` | The number of Operator replicas. |
| securityContext | object | `{"runAsNonRoot":true}` | Deployment pod security context. More information in [Kubernetes documentation](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/). |
| serviceAccount.annotations | object | `{}` | Additional annotations for the ServiceAccount. |
| serviceAccount.create | bool | `true` | Specifies whether a ServiceAccount should be created. |
| serviceAccount.name | string | `""` | The name of the service account to use. If not set and create is true, a name is generated using the fullname template. |
